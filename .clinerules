# GastoCerto ZAP - Claude Skills

## Contexto do Projeto

Este √© um projeto **NestJS** de chatbot WhatsApp/Telegram para controle financeiro pessoal integrado com a API GastoCerto.

### Tecnologias Principais
- **Framework**: NestJS 10+ (TypeScript)
- **Banco de Dados**: PostgreSQL com Prisma ORM
- **Cache**: Redis (via ioredis)
- **Mensageria**: Baileys (WhatsApp), node-telegram-bot-api (Telegram)
- **IA**: OpenAI GPT-4o-mini, Groq (Llama 3.1), Google Gemini
- **RAG**: BM25 para busca sem√¢ntica de categorias

---

## Estrutura do Projeto

```
src/
‚îú‚îÄ‚îÄ common/                 # Guards, decorators, services globais
‚îú‚îÄ‚îÄ core/                   # Database (Prisma), config base
‚îú‚îÄ‚îÄ features/               # M√≥dulos de neg√≥cio
‚îÇ   ‚îú‚îÄ‚îÄ admin/             # Admin API endpoints
‚îÇ   ‚îú‚îÄ‚îÄ admin-controllers/ # Controladores espec√≠ficos (RAG, etc)
‚îÇ   ‚îú‚îÄ‚îÄ intent/            # NLP intent analyzer
‚îÇ   ‚îú‚îÄ‚îÄ messages/          # Valida√ß√£o de mensagens
‚îÇ   ‚îú‚îÄ‚îÄ onboarding/        # Cadastro de novos usu√°rios
‚îÇ   ‚îú‚îÄ‚îÄ transactions/      # Registro de transa√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ users/             # User cache service
‚îÇ   ‚îî‚îÄ‚îÄ webchat/           # Web chat interface
‚îú‚îÄ‚îÄ infrastructure/        # Camada de infraestrutura
‚îÇ   ‚îú‚îÄ‚îÄ ai/                # IA services (OpenAI, Groq, Gemini)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rag/           # Sistema RAG (busca sem√¢ntica)
‚îÇ   ‚îú‚îÄ‚îÄ chat/              # WhatsApp chat cache
‚îÇ   ‚îú‚îÄ‚îÄ core/              # Session manager gen√©rico
‚îÇ   ‚îú‚îÄ‚îÄ database/          # Auth state managers
‚îÇ   ‚îú‚îÄ‚îÄ messaging/         # Multi-platform messaging
‚îÇ   ‚îú‚îÄ‚îÄ sessions/          # Session CRUD
‚îÇ   ‚îú‚îÄ‚îÄ telegram/          # Telegram-specific code
‚îÇ   ‚îî‚îÄ‚îÄ whatsapp/          # WhatsApp-specific code
‚îî‚îÄ‚îÄ prisma/
    ‚îî‚îÄ‚îÄ schema.prisma      # Database schema
```

---

## Conven√ß√µes de C√≥digo

### TypeScript Paths
```typescript
@common/*          ‚Üí src/common/*
@core/*            ‚Üí src/core/*
@features/*        ‚Üí src/features/*
@infrastructure/*  ‚Üí src/infrastructure/*
```

### Logging
```typescript
private readonly logger = new Logger(ClassName.name);
this.logger.log('‚úÖ Success message');
this.logger.warn('‚ö†Ô∏è Warning message');
this.logger.error('‚ùå Error message', error);
```

### Emojis Padr√£o
- ‚úÖ Sucesso
- ‚ùå Erro
- ‚ö†Ô∏è Warning
- üìä Stats/Dados
- üîç Busca/Search
- üéØ Intent/Matching
- üîÑ Processamento/Loop
- üíæ Cache/Storage
- üöÄ In√≠cio/Start
- üîß Debug/Fix
- üìù Log/Info

### Async/Await
- **SEMPRE** usar async/await (nunca .then/.catch)
- **SEMPRE** fazer try/catch em controllers
- **SEMPRE** logar erros com contexto

### Prisma
```typescript
// ‚úÖ Correto
const user = await this.prisma.userCache.findUnique({...});

// ‚ùå Evitar
const user = await prisma.userCache.findUnique({...});
```

---

## Sistema RAG (Retrieval-Augmented Generation)

### Fluxo Principal
1. **RAG BM25**: Busca sem√¢ntica em categorias indexadas
2. **Threshold**: Score >= 0.4 (40%) para match v√°lido
3. **AI Fallback**: Se RAG falha, usa IA (OpenAI/Groq)
4. **RAG Validation**: Valida resposta da IA no √≠ndice

### Endpoints RAG Admin
```bash
# Testar matching sem criar logs
POST /admin/rag/test-match
Body: { userId, query }

# Estat√≠sticas completas
GET /admin/rag/stats?year=2026&month=1

# Lista de logs (resumida)
GET /admin/rag/search-logs?limit=20

# Detalhes completos de um log
GET /admin/rag/search-logs/:id/details

# Adicionar sin√¥nimo global
POST /admin/rag/global-synonyms
Body: { term, targetCategory, targetSubCategory }
```

### Cache Redis
```
rag:categories:{gastoCertoId}    ‚Üí Categorias indexadas (JSON)
rag:embeddings:{gastoCertoId}    ‚Üí Embeddings de categorias
rag:learning:{phoneNumber}       ‚Üí Contexto de aprendizado (TTL: 5min)
user:{phoneNumber}               ‚Üí Cache de usu√°rio
```

---

## Comandos √öteis

### Build & Compila√ß√£o
```bash
npm run build              # Webpack build
npx tsc --noEmit          # Validar TypeScript
npm run start:dev         # Dev mode
```

### Testes
```bash
npm test                  # Todos os testes
npm test -- rag.service  # Teste espec√≠fico
npm run test:cov         # Com coverage
```

### Prisma
```bash
npx prisma generate      # Gerar cliente
npx prisma migrate dev   # Criar migration
npx prisma studio        # GUI do banco
```

### Docker
```bash
docker-compose up -d     # Subir Redis + Postgres
docker-compose logs -f   # Ver logs
```

---

## Modelos de Dados Cr√≠ticos

### UserCache
```prisma
model UserCache {
  id                    String
  phoneNumber           String  @unique  # SEM c√≥digo do pa√≠s
  gastoCertoId          String  @unique
  whatsappId            String?
  telegramId            String?
  activeAccountId       String?  # Conta ativa
  hasActiveSubscription Boolean
  isBlocked             Boolean
  isActive              Boolean
  categories            Json     # Categorias do usu√°rio
}
```

### RAGSearchLog
```prisma
model RAGSearchLog {
  id                String
  userId            String  # gastoCertoId
  query             String
  success           Boolean
  bestMatch         String?
  bestScore         Decimal
  threshold         Decimal
  ragMode           String   # "BM25" ou "AI"
  wasAiFallback     Boolean
  flowStep          Int      # 1, 2 ou 3
  totalSteps        Int
  responseTime      Int?     # ms
}
```

### TransactionConfirmation
```prisma
model TransactionConfirmation {
  id               String
  phoneNumber      String
  platform         String  # whatsapp | telegram
  type             TransactionType  # INCOME | EXPENSE
  amount           Decimal
  categoryId       String?
  status           ConfirmationStatus  # PENDING | CONFIRMED | EXPIRED
  ragSearchLogId   String?  # Link com RAG log
}
```

---

## Padr√µes de Resposta

### API Admin
```typescript
return {
  success: true,
  data: {...},
  pagination?: {...},
  stats?: {...},
  timestamp: new Date().toISOString(),
};
```

### Errors
```typescript
return {
  success: false,
  message: 'Mensagem de erro',
  error: error.message,
  timestamp: new Date().toISOString(),
};
```

---

## Multi-Platform (WhatsApp + Telegram)

### Event-Driven Architecture
```typescript
// Emissor
this.eventEmitter.emit('whatsapp.message', { sessionId, message, platform });

// Listener
@OnEvent('whatsapp.message')
async handleMessage(event: MessageReceivedEvent) {...}
```

### Identificadores
- **WhatsApp**: `phoneNumber` (5566996285154)
- **Telegram**: `chatId` (707624962)
- **Unificado**: Sempre usar `phoneNumber` do UserCache

---

## Graceful Shutdown

### CR√çTICO para evitar sess√µes bloqueadas
```typescript
// main.ts
app.enableShutdownHooks();

process.on('SIGTERM', async () => {
  await app.close();
});

// Services
async onModuleDestroy() {
  await this.disconnect();
}
```

---

## Debug & Troubleshooting

### RAG n√£o encontra categoria
1. Verificar se categoria est√° indexada:
   ```bash
   GET /admin/rag/test-match
   # Ver debug.totalCategoriesIndexed
   ```

2. Ver categorias mais pr√≥ximas:
   ```bash
   # Ver debug.topNonMatchingCategories
   ```

3. Criar sin√¥nimo se necess√°rio:
   ```bash
   POST /admin/rag/global-synonyms
   ```

### Sess√£o bloqueada (Telegram/WhatsApp)
- Ver: `docs/GRACEFUL_SHUTDOWN_FIX.md`
- Verificar se `onModuleDestroy` est√° implementado
- Conferir logs: `‚úÖ Redis desconectado`, `‚úÖ Sess√µes desconectadas`

### Usu√°rio n√£o recebe mensagens
1. Verificar contexto da plataforma:
   ```typescript
   this.contextService.registerContext(userId, sessionId, platform);
   ```

2. Ver se evento est√° sendo emitido:
   ```typescript
   this.eventEmitter.emit('telegram.reply', { platformId, message });
   ```

---

## Documenta√ß√£o Importante

- `docs/RAG_ADMIN_QUICK_GUIDE.md` - Guia r√°pido endpoints RAG
- `docs/RAG_ADMIN_STATS_API.md` - Documenta√ß√£o completa stats
- `docs/RAG_LEARNING_DEBUG_GUIDE.md` - Debug do fluxo de aprendizado
- `docs/PLATFORM_FLOW_COMPARISON.md` - Compara√ß√£o WhatsApp vs Telegram
- `docs/GRACEFUL_SHUTDOWN_FIX.md` - Fix para sess√µes bloqueadas

---

## Regras de Edi√ß√£o

### Quando editar arquivos:
1. **SEMPRE** incluir 3-5 linhas de contexto antes e depois
2. **NUNCA** usar placeholders como `...existing code...`
3. **SEMPRE** validar com `npx tsc --noEmit`
4. **SEMPRE** rodar testes se mexer em l√≥gica de neg√≥cio

### Ordem de rotas NestJS:
```typescript
// ‚úÖ CORRETO: Espec√≠ficas primeiro
@Get('users-cache/count')
@Get('users-cache/search')
@Get('users-cache/:id')
@Get('users-cache')

// ‚ùå ERRADO: Gen√©rica captura todas
@Get('users-cache')
@Get('users-cache/search')  // Nunca ser√° chamada!
```

### Prisma Decimal:
```typescript
// ‚úÖ CORRETO: Converter para number
Number(log.bestScore)

// ‚ùå ERRADO: Usar direto
log.bestScore + 1  // Erro de tipo
```

---

## Performance

### N+1 Queries
```typescript
// ‚ùå Evitar
for (const log of logs) {
  const user = await this.prisma.userCache.findUnique(...);
}

// ‚úÖ Correto
const enrichedLogs = await Promise.all(
  logs.map(async (log) => {
    const user = await this.cacheService.getUserByGastoCertoId(log.userId);
    return { ...log, userName: user?.name };
  })
);
```

### Redis
- Use pipeline para m√∫ltiplas opera√ß√µes
- Sempre definir TTL em caches tempor√°rios
- Prefixar keys: `rag:`, `user:`, etc.

---

## Testes

### Mock de Services
```typescript
const mockRagService = {
  findSimilarCategories: jest.fn().mockResolvedValue([...]),
};

const mockUserCache = {
  getUser: jest.fn().mockResolvedValue(mockUser),
  getUserByGastoCertoId: jest.fn().mockResolvedValue(mockUser),
};
```

### Prisma em Testes
```typescript
// Adicionar null check em m√©todos que usam prisma
if (!this.prisma) {
  this.logger.warn('‚ö†Ô∏è Prisma n√£o dispon√≠vel em testes');
  return null;
}
```

---

## KPIs Importantes

| M√©trica | Meta | Cr√≠tico |
|---------|------|---------|
| RAG Success Rate | > 85% | < 70% |
| AI Fallback Rate | < 15% | > 30% |
| Avg Response Time | < 100ms | > 500ms |
| Test Coverage | > 80% | < 60% |

---

## Contatos & Recursos

- **Projeto**: GastoCerto ZAP
- **API Base**: https://api.gastocerto.com.br
- **Ambiente**: Dev em http://localhost:4444
- **Redis**: localhost:6379
- **PostgreSQL**: localhost:5432

---

## Quick Commands

```bash
# Subir ambiente completo
docker-compose up -d && npm run start:dev

# Rebuild completo
rm -rf dist && npm run build

# Ver logs do RAG
grep "üéØ" logs/app.log

# Limpar cache Redis
docker exec -it <redis-container> redis-cli FLUSHALL

# Ver estat√≠sticas do m√™s
curl "http://localhost:4444/admin/rag/stats?year=2026&month=1"

# Testar matching
curl -X POST http://localhost:4444/admin/rag/test-match \
  -H "Content-Type: application/json" \
  -d '{"userId":"USER_ID","query":"gastei na padaria"}'
```

---

## Notas Finais

- **Multi-plataforma**: WhatsApp e Telegram compartilham a mesma l√≥gica de neg√≥cio
- **Event-driven**: Toda comunica√ß√£o entre m√≥dulos via eventos
- **Graceful shutdown**: CR√çTICO para evitar sess√µes √≥rf√£s
- **RAG-first**: Sempre tentar RAG antes de usar IA (custo)
- **Cache agressivo**: Redis para tudo que puder (categorias, usu√°rios)
- **Logs detalhados**: Usar emojis para facilitar grep

**√öltima atualiza√ß√£o**: 13 de janeiro de 2026

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Sess√µes WhatsApp
model WhatsAppSession {
  id            String        @id @default(uuid())
  sessionId     String        @unique
  phoneNumber   String // Removido @unique - ser√° preenchido ap√≥s QR code
  name          String?
  status        SessionStatus @default(INACTIVE)
  creds         Json? // Credenciais Baileys (chaves, tokens)
  isActive      Boolean       @default(true)
  lastSeen      DateTime?
  lastConnected DateTime? // √öltima conex√£o bem-sucedida
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([phoneNumber])
  @@index([status])
  @@map("whatsapp_sessions")
}

// Sess√µes Telegram
model TelegramSession {
  id        String        @id @default(uuid())
  sessionId String        @unique
  name      String
  token     String // Token do bot obtido via @BotFather
  status    SessionStatus @default(INACTIVE)
  isActive  Boolean       @default(true)
  lastSeen  DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([status])
  @@map("telegram_sessions")
}

enum SessionStatus {
  INACTIVE
  CONNECTING
  QR_PENDING
  CONNECTED
  DISCONNECTED
  ERROR
}

// Sess√µes de Onboarding (cadastro de novos usu√°rios)
model OnboardingSession {
  id            String         @id @default(uuid())
  platformId    String         @unique // Telegram chatId ou WhatsApp number
  phoneNumber   String? // Telefone real do usu√°rio (opcional at√© ser coletado)
  currentStep   OnboardingStep @default(COLLECT_NAME)
  data          Json           @default("{}")
  attempts      Int            @default(0)
  lastMessageAt DateTime       @default(now())
  expiresAt     DateTime // 30 minutos de inatividade
  completed     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([platformId])
  @@index([phoneNumber])
  @@index([expiresAt])
  @@map("onboarding_sessions")
}

enum OnboardingStep {
  COLLECT_NAME
  COLLECT_EMAIL
  REQUEST_PHONE
  CHECK_EXISTING_USER
  REQUEST_VERIFICATION_CODE
  VERIFY_CODE
  CHOOSE_ACCOUNT
  CONFIRM_DATA
  CREATING_ACCOUNT
  COMPLETED
}

// Cache de usu√°rios da API Gasto Certo
model UserCache {
  id                    String  @id @default(uuid())
  phoneNumber           String  @unique // Telefone normalizado SEM c√≥digo do pa√≠s: 66996285154 - CHAVE √öNICA para suportar multi-plataforma
  gastoCertoId          String  @unique // ID do usu√°rio no sistema Gasto Certo
  whatsappId            String? // ID do usu√°rio no WhatsApp (ex: 5566996285154@s.whatsapp.net) - Pode ser null se n√£o vinculado
  telegramId            String? // ID do chat do usu√°rio no Telegram (ex: 707624962) - Pode ser null se n√£o vinculado
  email                 String
  name                  String
  hasActiveSubscription Boolean @default(false)
  isBlocked             Boolean @default(false) // üÜï Usu√°rio bloqueado (n√£o pode usar o sistema)
  isActive              Boolean @default(true) // üÜï Usu√°rio ativo (conta n√£o desativada)

  // üÜï Gerenciamento de m√∫ltiplas contas
  activeAccountId     String? // ID da conta ativa no momento (usado para todas opera√ß√µes)
  accounts            Json    @default("[]") // Array de contas: [{ id, name, type, isPrimary }]
  defaultCreditCardId String? // ‚ú® NOVO: ID do cart√£o de cr√©dito padr√£o

  categories               Json                      @default("[]")
  preferences              Json?
  lastSyncAt               DateTime                  @default(now())
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  unrecognizedMessages     UnrecognizedMessage[] // Mensagens n√£o reconhecidas deste usu√°rio
  transactionConfirmations TransactionConfirmation[] // Confirma√ß√µes de transa√ß√µes deste usu√°rio

  @@index([phoneNumber])
  @@index([gastoCertoId])
  @@index([whatsappId])
  @@index([telegramId])
  @@index([activeAccountId])
  @@map("user_cache")
}

// Confirma√ß√µes de transa√ß√µes pendentes
model TransactionConfirmation {
  id               String             @id @default(uuid())
  phoneNumber      String
  platform         String             @default("whatsapp") // Plataforma de origem: whatsapp | telegram
  userId           String? // ID do UserCache - rela√ß√£o com usu√°rio
  user             UserCache?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  accountId        String? // ID da conta ativa no momento da transa√ß√£o
  messageId        String             @unique
  type             TransactionType
  amount           Decimal            @db.Decimal(10, 2)
  category         String // Nome da categoria (mantido para compatibilidade)
  categoryId       String? // ID da categoria resolvida
  subCategoryId    String? // ID da subcategoria resolvida (se houver)
  subCategoryName  String? // Nome da subcategoria (para exibir ao usu√°rio)
  description      String?
  date             DateTime           @default(now())
  extractedData    Json // Dados brutos extra√≠dos pela IA
  status           ConfirmationStatus @default(PENDING)
  confirmedAt      DateTime?
  notifiedExpiring Boolean            @default(false) // Se j√° enviou aviso de expira√ß√£o pr√≥xima

  // Campos para tracking/an√°lise (relacionar com logs da IA/RAG)
  aiUsageLogId   String? // ID do log de uso da IA (se usou IA)
  ragSearchLogId String? // ID do log de busca RAG (se usou RAG)

  // Campos para controle de envio para API
  apiSent Boolean @default(false) // Se foi enviado para API GastoCerto

  // ‚ú® NOVOS CAMPOS - Transa√ß√µes Avan√ßadas
  isFixed           Boolean   @default(false) // Transa√ß√£o recorrente/fixa
  fixedFrequency    String? // MONTHLY, WEEKLY, ANNUAL, BIENNIAL
  installments      Int? // N√∫mero total de parcelas
  installmentNumber Int       @default(1) // N√∫mero da parcela atual
  creditCardId      String? // ID do cart√£o de cr√©dito usado
  paymentStatus     String    @default("DONE") // PENDING ou DONE
  invoiceMonth      String? // M√™s da fatura (YYYY-MM) para cart√£o de cr√©dito
  apiSentAt         DateTime? // Quando foi enviado com sucesso
  apiError          String? // √öltima mensagem de erro da API
  apiRetryCount     Int       @default(0) // N√∫mero de tentativas de envio

  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([phoneNumber])
  @@index([platform])
  @@index([userId])
  @@index([accountId])
  @@index([status])
  @@index([expiresAt])
  @@index([apiSent])
  @@index([status, apiSent])
  @@map("transaction_confirmations")
}

enum TransactionType {
  EXPENSES
  INCOME
}

enum ConfirmationStatus {
  PENDING
  CONFIRMED
  REJECTED
  EXPIRED
}

// Log de uso de IA (tokens e custos)
model AIUsageLog {
  id            String          @id @default(uuid())
  userCacheId   String? // ID do UserCache (pode ser null se usu√°rio ainda n√£o cadastrado)
  phoneNumber   String // Telefone do usu√°rio (sempre presente)
  provider      String // openai, google-gemini, groq
  model         String // gpt-4o, gemini-1.5-pro, etc
  operation     AIOperationType // Tipo de opera√ß√£o
  inputType     AIInputType // text, audio, image
  inputText     String? // Texto de entrada (se aplic√°vel)
  inputTokens   Int // Tokens de entrada
  outputTokens  Int // Tokens de sa√≠da
  totalTokens   Int // Total de tokens
  estimatedCost Decimal         @db.Decimal(10, 6) // Custo estimado em USD
  responseTime  Int? // Tempo de resposta em ms
  success       Boolean         @default(true)
  errorMessage  String?
  metadata      Json? // Dados adicionais (ex: confidence, categoria extra√≠da)

  // üÜï Contexto RAG para an√°lise e melhoria
  ragSearchLogId       String? // ID do RAGSearchLog relacionado (se veio do fluxo RAG)
  ragSearchLog         RAGSearchLog? @relation(fields: [ragSearchLogId], references: [id], onDelete: SetNull)
  ragInitialFound      Boolean? // true se RAG encontrou algo no step 1 (mesmo abaixo do threshold)
  ragInitialScore      Decimal?      @db.Decimal(5, 4) // Score do RAG inicial (step 1)
  ragInitialCategory   String? // Categoria que RAG sugeriu no step 1
  aiCategoryId         String? // ID da categoria que IA retornou
  aiCategoryName       String? // Nome da categoria que IA retornou
  aiConfidence         Decimal?      @db.Decimal(5, 4) // Confian√ßa da IA
  finalCategoryId      String? // ID da categoria final escolhida (ap√≥s valida√ß√£o)
  finalCategoryName    String? // Nome da categoria final escolhida
  wasRagFallback       Boolean       @default(false) // true se foi fallback de RAG que falhou
  needsSynonymLearning Boolean       @default(false) // true se deve extrair sin√¥nimos desta intera√ß√£o

  createdAt DateTime @default(now())

  @@index([userCacheId])
  @@index([phoneNumber])
  @@index([provider])
  @@index([operation])
  @@index([createdAt])
  @@index([ragSearchLogId]) // Para vincular com RAG log
  @@index([wasRagFallback]) // Para an√°lise de fallbacks
  @@index([needsSynonymLearning]) // Para processar aprendizado de sin√¥nimos
  @@map("ai_usage_logs")
}

// Log de tentativas de busca RAG (para analytics e melhoria cont√≠nua)
model RAGSearchLog {
  id              String   @id @default(uuid())
  userId          String // gastoCertoId do UserCache
  query           String // Texto de busca (ex: "rotativo", "gasolina")
  queryNormalized String // Query normalizada (lowercase, sem acentos)
  matches         Json // Array de matches encontrados com scores
  bestMatch       String? // Nome da melhor categoria encontrada
  bestScore       Decimal? @db.Decimal(5, 4) // Score do melhor match normalizado (0.0000 - 1.0000 = 0-100%)
  threshold       Decimal  @db.Decimal(5, 4) // Threshold usado na busca (sempre 0-1)
  success         Boolean // true se encontrou match >= threshold
  ragMode         String   @default("BM25") // "BM25" ou "AI" (embeddings)
  responseTime    Int? // Tempo de resposta em ms

  // üÜï Rastreamento completo do fluxo RAG ‚Üí IA ‚Üí RAG
  flowStep          Int      @default(1) // 1=RAG inicial, 2=IA fallback, 3=RAG valida√ß√£o final
  totalSteps        Int      @default(1) // Total de steps executados (1, 2 ou 3)
  aiProvider        String? // Provider de IA usado se ragMode="AI" ou flowStep=2 (ex: "openai", "groq")
  aiModel           String? // Modelo usado (ex: "text-embedding-ada-002", "gpt-4o")
  aiConfidence      Decimal? @db.Decimal(5, 4) // Confian√ßa da IA (se usou IA no step 2) - sempre 0-1
  aiCategoryId      String? // ID da categoria que a IA retornou (step 2)
  aiCategoryName    String? // Nome da categoria que a IA retornou (step 2)
  finalCategoryId   String? // ID da categoria final escolhida (ap√≥s todos os steps)
  finalCategoryName String? // Nome da categoria final escolhida
  ragInitialScore   Decimal? @db.Decimal(5, 4) // Score do RAG no step 1 normalizado (0-1)
  ragFinalScore     Decimal? @db.Decimal(5, 4) // Score do RAG no step 3 normalizado (0-1)
  wasAiFallback     Boolean  @default(false) // true se precisou usar IA (step 2) porque RAG falhou

  // Relacionamento com AIUsageLog
  aiUsageLogs AIUsageLog[]

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([success])
  @@index([createdAt])
  @@index([userId, success]) // Para queries falhas por usu√°rio
  @@index([wasAiFallback]) // Para an√°lise de quando IA foi necess√°ria
  @@index([flowStep]) // Para an√°lise por step
  @@index([aiProvider]) // Para an√°lise por provider de IA
  @@map("rag_search_logs")
}

// Sin√¥nimos personalizados por usu√°rio para RAG
// Permite que o sistema aprenda termos espec√≠ficos de cada usu√°rio
// Ex: "pro labore" ‚Üí Categoria "Receitas ‚Üí Sal√°rio", "inss" ‚Üí "Impostos ‚Üí INSS"
model UserSynonym {
  id              String        @id @default(uuid())
  userId          String // gastoCertoId do UserCache
  keyword         String // Palavra-chave normalizada (ex: "pro labore", "inss", "das", "notebook")
  categoryId      String // ID da categoria mapeada na API externa
  categoryName    String // Nome da categoria (cache para exibi√ß√£o)
  subCategoryId   String? // ID da subcategoria (se houver)
  subCategoryName String? // Nome da subcategoria (cache para exibi√ß√£o)
  confidence      Float         @default(1.0) // Confian√ßa do mapeamento (0-1): USER_CONFIRMED=1.0, AI_SUGGESTED=0.7, AUTO_LEARNED=0.5
  source          SynonymSource @default(USER_CONFIRMED) // Origem do sin√¥nimo
  usageCount      Int           @default(0) // Quantas vezes foi usado (para analytics)
  lastUsedAt      DateTime? // √öltima vez que foi usado
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([userId, keyword]) // Um usu√°rio n√£o pode ter keywords duplicadas
  @@index([userId]) // Buscar todos sin√¥nimos de um usu√°rio
  @@index([userId, keyword]) // Buscar sin√¥nimo espec√≠fico rapidamente
  @@index([usageCount]) // Analytics: sin√¥nimos mais usados
  @@map("user_synonyms")
}

enum SynonymSource {
  USER_CONFIRMED // Usu√°rio confirmou explicitamente: "Sim, 'pro labore' √© Receitas ‚Üí Sal√°rio"
  AI_SUGGESTED // IA sugeriu e usu√°rio aceitou
  AUTO_LEARNED // Sistema aprendeu automaticamente (padr√£o detectado)
  IMPORTED // Importado de outro usu√°rio ou base de conhecimento
  ADMIN_APPROVED // Admin criou/aprovou manualmente
}

enum AIOperationType {
  TRANSACTION_EXTRACTION // Extrair dados de transa√ß√£o
  AUDIO_TRANSCRIPTION // Transcrever √°udio
  IMAGE_ANALYSIS // Analisar imagem/nota fiscal
  CATEGORY_SUGGESTION // Sugerir categoria
  RAG_EMBEDDING // Gerar embeddings para RAG (busca sem√¢ntica)
  INTENT_DETECTION // Detectar inten√ß√£o do usu√°rio
}

enum AIInputType {
  TEXT
  AUDIO
  IMAGE
}

// Log de mensagens n√£o reconhecidas (para treinamento de NLP)
model UnrecognizedMessage {
  id             String     @id @default(uuid())
  userCacheId    String? // ID do UserCache (pode ser null se usu√°rio ainda n√£o cadastrado)
  userCache      UserCache? @relation(fields: [userCacheId], references: [id], onDelete: SetNull)
  phoneNumber    String // Telefone do usu√°rio
  messageText    String // Texto da mensagem enviada
  detectedIntent String? // Inten√ß√£o detectada pelo NLP (se houver)
  confidence     Float? // Confian√ßa da detec√ß√£o (0-1)
  wasProcessed   Boolean    @default(false) // Se foi processado pela IA depois
  addedToContext Boolean    @default(false) // Se foi adicionado ao contexto de treinamento
  userFeedback   String? // Feedback do usu√°rio sobre o que queria fazer
  metadata       Json? // Dados adicionais (contexto, tentativas, etc)
  createdAt      DateTime   @default(now())

  @@index([userCacheId])
  @@index([phoneNumber])
  @@index([wasProcessed])
  @@index([addedToContext])
  @@index([createdAt])
  @@map("unrecognized_messages")
}

// Configura√ß√µes de Provedores de IA
model AIProviderConfig {
  id          String  @id @default(uuid())
  provider    String  @unique // openai, google_gemini, groq, deepseek
  displayName String // Nome amig√°vel para exibi√ß√£o
  enabled     Boolean @default(true) // Se o provider est√° ativo
  apiKey      String? // API Key (pode ser null se desabilitado)
  baseUrl     String? // URL base da API (ex: https://api.deepseek.com)

  // Modelos por tipo de opera√ß√£o
  textModel   String? // Modelo para texto (ex: gpt-4o, deepseek-chat)
  visionModel String? // Modelo para vis√£o/imagem
  audioModel  String? // Modelo para √°udio/transcri√ß√£o

  // Rate Limits
  rpmLimit Int? @default(0) // Requests per minute (0 = ilimitado)
  tpmLimit Int? @default(0) // Tokens per minute (0 = ilimitado)

  // Custos (USD por 1M tokens)
  inputCostPer1M  Decimal? @db.Decimal(10, 6) // Custo de input por 1M tokens
  outputCostPer1M Decimal? @db.Decimal(10, 6) // Custo de output por 1M tokens
  cacheCostPer1M  Decimal? @db.Decimal(10, 6) // Custo de cache hit por 1M tokens

  // Features
  supportsVision Boolean @default(false)
  supportsAudio  Boolean @default(false)
  supportsCache  Boolean @default(false)
  cacheEnabled   Boolean @default(false) // Se cache est√° ativo

  // Prioridade e fallback
  priority        Int     @default(999) // Menor = maior prioridade
  fallbackEnabled Boolean @default(true) // Se pode ser usado como fallback

  // Metadata e controle
  metadata      Json?     @default("{}") // Configura√ß√µes extras
  lastUsedAt    DateTime?
  totalRequests Int       @default(0)
  totalErrors   Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([provider])
  @@index([enabled])
  @@index([priority])
  @@map("ai_provider_configs")
}

// Configura√ß√µes Globais de IA
model AISettings {
  id String @id @default(uuid())

  // Providers por tipo de opera√ß√£o
  textProvider     String @default("openai") // Provider para extra√ß√£o de texto
  imageProvider    String @default("google_gemini") // Provider para an√°lise de imagens
  audioProvider    String @default("groq") // Provider para transcri√ß√£o de √°udio
  categoryProvider String @default("groq") // Provider para sugest√£o de categorias

  // Provider Principal (deprecated - usar os campos acima)
  primaryProvider String @default("groq") // Provider padr√£o a ser usado

  // Fallback
  fallbackEnabled       Boolean  @default(true) // Se fallback est√° ativo
  fallbackTextChain     String[] @default(["groq", "deepseek", "google_gemini", "openai"]) // Sequ√™ncia para texto
  fallbackImageChain    String[] @default(["google_gemini", "openai"]) // Sequ√™ncia para imagem
  fallbackAudioChain    String[] @default(["openai", "groq"]) // Sequ√™ncia para √°udio
  fallbackCategoryChain String[] @default(["groq", "deepseek", "google_gemini", "openai"]) // Sequ√™ncia para categorias

  // Cache
  cacheEnabled Boolean @default(false) // Se cache global est√° ativo
  cacheTTL     Int     @default(3600) // TTL do cache em segundos (1 hora)

  // Rate Limiting
  rateLimitEnabled Boolean @default(true) // Se rate limiting est√° ativo

  // RAG (Retrieval-Augmented Generation)
  ragEnabled      Boolean @default(false) // Se RAG est√° ativo (busca vetorial)
  ragAiEnabled    Boolean @default(false) // Se usa IA para embeddings (true) ou BM25 (false)
  ragAiProvider   String  @default("groq") // Provider de IA para embeddings: "openai", "groq", "google_gemini"
  ragProvider     String  @default("bm25") // M√©todo: "openai" (com IA paga), "local" (sentence-transformers), "bm25" (sem IA)
  ragThreshold    Float   @default(0.6) // Threshold de similaridade (0-1) - Reduzido para 60%
  ragCacheEnabled Boolean @default(true) // Cache de embeddings

  // Assistente Conversacional
  assistantEnabled        Boolean @default(true) // Assistente humanizado ativo
  assistantPersonality    String  @default("friendly") // "friendly", "professional", "casual"
  assistantMaxHistoryMsgs Int     @default(5) // M√°ximo de mensagens no hist√≥rico de contexto

  // Transaction Processing
  autoRegisterThreshold  Float @default(0.90) @map("auto_register_threshold") // Registra automaticamente se confidence >= 90%
  minConfidenceThreshold Float @default(0.50) @map("min_confidence_threshold") // Rejeita transa√ß√µes com confidence < 50%

  // Seguran√ßa
  securityEnabled          Boolean @default(true) // Camada de seguran√ßa ativa
  securityMaxMessageLength Int     @default(500) // Tamanho m√°ximo de mensagem
  securityRateLimitMinute  Int     @default(20) // M√°ximo de mensagens por minuto
  securityRateLimitHour    Int     @default(100) // M√°ximo de mensagens por hora
  securityLogEvents        Boolean @default(true) // Logar eventos de seguran√ßa

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_settings")
}

// Logs de Seguran√ßa (leve, auto-limpeza)
model SecurityLog {
  id        String           @id @default(uuid())
  userId    String // ID do UserCache ou "unknown"
  eventType String // injection_attempt, rate_limit_exceeded, suspicious_content, etc
  details   String           @db.VarChar(500) // Primeiros 500 chars da mensagem
  severity  SecuritySeverity @default(low)
  createdAt DateTime         @default(now())

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([severity, createdAt])
  @@map("security_logs")
}

enum SecuritySeverity {
  low
  medium
  high
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model WhatsAppSession {
  id            String        @id @default(uuid())
  sessionId     String        @unique
  phoneNumber   String
  name          String?
  status        SessionStatus @default(INACTIVE)
  creds         Json?
  isActive      Boolean       @default(true)
  lastSeen      DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  lastConnected DateTime?

  @@index([phoneNumber])
  @@index([status])
  @@map("whatsapp_sessions")
}

model TelegramSession {
  id        String        @id @default(uuid())
  sessionId String        @unique
  name      String
  token     String
  status    SessionStatus @default(INACTIVE)
  isActive  Boolean       @default(true)
  lastSeen  DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([status])
  @@map("telegram_sessions")
}

model OnboardingSession {
  id            String         @id @default(uuid())
  platformId    String         @unique
  phoneNumber   String?
  currentStep   OnboardingStep @default(COLLECT_NAME)
  data          Json           @default("{}")
  attempts      Int            @default(0)
  lastMessageAt DateTime       @default(now())
  expiresAt     DateTime
  completed     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([platformId])
  @@index([phoneNumber])
  @@index([expiresAt])
  @@map("onboarding_sessions")
}

model UserCache {
  id                       String                    @id @default(uuid())
  phoneNumber              String                    @unique
  gastoCertoId             String                    @unique
  whatsappId               String?
  telegramId               String?
  email                    String
  name                     String
  hasActiveSubscription    Boolean                   @default(false)
  activeAccountId          String?
  accounts                 Json                      @default("[]")
  categories               Json                      @default("[]")
  preferences              Json?
  lastSyncAt               DateTime                  @default(now())
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  isBlocked                Boolean                   @default(false)
  isActive                 Boolean                   @default(true)
  defaultCreditCardId      String?
  transactionConfirmations TransactionConfirmation[]
  unrecognizedMessages     UnrecognizedMessage[]
  synonyms                 UserSynonym[]

  @@index([phoneNumber])
  @@index([gastoCertoId])
  @@index([whatsappId])
  @@index([telegramId])
  @@index([activeAccountId])
  @@map("user_cache")
}

model TransactionConfirmation {
  id                String             @id @default(uuid())
  phoneNumber       String
  platform          String             @default("whatsapp")
  userId            String?
  accountId         String?
  messageId         String             @unique
  type              TransactionType
  amount            Decimal            @db.Decimal(10, 2)
  category          String
  categoryId        String?
  subCategoryId     String?
  subCategoryName   String?
  description       String?
  date              DateTime           @default(now())
  extractedData     Json
  status            ConfirmationStatus @default(PENDING)
  confirmedAt       DateTime?
  notifiedExpiring  Boolean            @default(false)
  apiSent           Boolean            @default(false)
  apiSentAt         DateTime?
  apiError          String?
  apiRetryCount     Int                @default(0)
  createdAt         DateTime           @default(now())
  expiresAt         DateTime
  aiUsageLogId      String?
  ragSearchLogId    String?
  creditCardId      String?
  fixedFrequency    String?
  installmentNumber Int                @default(1)
  installments      Int?
  invoiceMonth      String?
  isFixed           Boolean            @default(false)
  paymentStatus     String             @default("DONE")
  deletedAt         DateTime?
  user              UserCache?         @relation(fields: [userId], references: [id])

  @@index([phoneNumber])
  @@index([platform])
  @@index([userId])
  @@index([deletedAt])
  @@index([accountId])
  @@index([status])
  @@index([expiresAt])
  @@index([apiSent])
  @@index([status, apiSent])
  @@map("transaction_confirmations")
}

model AIUsageLog {
  id                   String          @id @default(uuid())
  userCacheId          String?
  phoneNumber          String
  provider             String
  model                String
  operation            AIOperationType
  inputType            AIInputType
  inputText            String?
  inputTokens          Int
  outputTokens         Int
  totalTokens          Int
  estimatedCost        Decimal         @db.Decimal(10, 6)
  responseTime         Int?
  success              Boolean         @default(true)
  errorMessage         String?
  metadata             Json?
  createdAt            DateTime        @default(now())
  ragSearchLogId       String?
  ragInitialFound      Boolean?
  ragInitialScore      Decimal?        @db.Decimal(5, 4)
  ragInitialCategory   String?
  aiCategoryId         String?
  aiCategoryName       String?
  aiConfidence         Decimal?        @db.Decimal(5, 4)
  finalCategoryId      String?
  finalCategoryName    String?
  wasRagFallback       Boolean         @default(false)
  needsSynonymLearning Boolean         @default(false)
  ragSearchLog         RAGSearchLog?   @relation(fields: [ragSearchLogId], references: [id])

  @@index([userCacheId])
  @@index([phoneNumber])
  @@index([provider])
  @@index([operation])
  @@index([createdAt])
  @@index([ragSearchLogId])
  @@index([wasRagFallback])
  @@index([needsSynonymLearning])
  @@map("ai_usage_logs")
}

model RAGSearchLog {
  id                String       @id @default(uuid())
  userId            String
  query             String
  queryNormalized   String
  matches           Json
  bestMatch         String?
  bestScore         Decimal?     @db.Decimal(6, 4)
  threshold         Decimal      @db.Decimal(5, 4)
  success           Boolean
  ragMode           String       @default("BM25")
  responseTime      Int?
  createdAt         DateTime     @default(now())
  flowStep          Int          @default(1)
  totalSteps        Int          @default(1)
  aiProvider        String?
  aiModel           String?
  aiConfidence      Decimal?     @db.Decimal(5, 4)
  aiCategoryId      String?
  aiCategoryName    String?
  finalCategoryId   String?
  finalCategoryName String?
  ragInitialScore   Decimal?     @db.Decimal(5, 4)
  ragFinalScore     Decimal?     @db.Decimal(5, 4)
  wasAiFallback     Boolean      @default(false)
  aiUsageLogs       AIUsageLog[]

  @@index([userId])
  @@index([success])
  @@index([createdAt])
  @@index([userId, success])
  @@index([wasAiFallback])
  @@index([flowStep])
  @@index([aiProvider])
  @@map("rag_search_logs")
}

model UserSynonym {
  id              String        @id @default(uuid())
  userId          String?
  keyword         String
  categoryId      String?
  categoryName    String
  source          SynonymSource @default(USER_CONFIRMED)
  usageCount      Int           @default(0)
  lastUsedAt      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  subCategoryId   String?
  subCategoryName String?
  confidence      Float         @default(1.0)

  // Relacionamento com UserCache
  user UserCache? @relation(fields: [userId], references: [gastoCertoId], onDelete: Cascade)

  @@unique([userId, keyword])
  @@index([userId])
  @@index([userId, keyword])
  @@index([usageCount])
  @@map("user_synonyms")
}

model UnrecognizedMessage {
  id             String     @id @default(uuid())
  userCacheId    String?
  phoneNumber    String
  messageText    String
  detectedIntent String?
  confidence     Float?
  wasProcessed   Boolean    @default(false)
  addedToContext Boolean    @default(false)
  userFeedback   String?
  metadata       Json?
  createdAt      DateTime   @default(now())
  userCache      UserCache? @relation(fields: [userCacheId], references: [id])

  @@index([userCacheId])
  @@index([phoneNumber])
  @@index([wasProcessed])
  @@index([addedToContext])
  @@index([createdAt])
  @@map("unrecognized_messages")
}

model AIProviderConfig {
  id              String    @id @default(uuid())
  provider        String    @unique
  displayName     String
  enabled         Boolean   @default(true)
  apiKey          String?
  baseUrl         String?
  textModel       String?
  visionModel     String?
  audioModel      String?
  rpmLimit        Int?      @default(0)
  tpmLimit        Int?      @default(0)
  inputCostPer1M  Decimal?  @db.Decimal(10, 6)
  outputCostPer1M Decimal?  @db.Decimal(10, 6)
  cacheCostPer1M  Decimal?  @db.Decimal(10, 6)
  supportsVision  Boolean   @default(false)
  supportsAudio   Boolean   @default(false)
  supportsCache   Boolean   @default(false)
  cacheEnabled    Boolean   @default(false)
  priority        Int       @default(999)
  fallbackEnabled Boolean   @default(true)
  metadata        Json?     @default("{}")
  lastUsedAt      DateTime?
  totalRequests   Int       @default(0)
  totalErrors     Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([provider])
  @@index([enabled])
  @@index([priority])
  @@map("ai_provider_configs")
}

model AISettings {
  id                       String   @id @default(uuid())
  textProvider             String   @default("openai")
  imageProvider            String   @default("google_gemini")
  audioProvider            String   @default("groq")
  categoryProvider         String   @default("groq")
  primaryProvider          String   @default("groq")
  fallbackEnabled          Boolean  @default(true)
  fallbackTextChain        String[] @default(["groq", "deepseek", "google_gemini", "openai"])
  fallbackImageChain       String[] @default(["google_gemini", "openai"])
  fallbackAudioChain       String[] @default(["openai", "groq"])
  fallbackCategoryChain    String[] @default(["groq", "deepseek", "google_gemini", "openai"])
  cacheEnabled             Boolean  @default(false)
  cacheTTL                 Int      @default(3600)
  rateLimitEnabled         Boolean  @default(true)
  ragEnabled               Boolean  @default(false)
  ragAiEnabled             Boolean  @default(false)
  ragAiProvider            String   @default("groq")
  ragProvider              String   @default("bm25")
  ragThreshold             Float    @default(0.6)
  ragCacheEnabled          Boolean  @default(true)
  assistantEnabled         Boolean  @default(true)
  assistantPersonality     String   @default("friendly")
  assistantMaxHistoryMsgs  Int      @default(5)
  autoRegisterThreshold    Float    @default(0.90) @map("auto_register_threshold")
  minConfidenceThreshold   Float    @default(0.50) @map("min_confidence_threshold")
  securityEnabled          Boolean  @default(true)
  securityMaxMessageLength Int      @default(500)
  securityRateLimitMinute  Int      @default(20)
  securityRateLimitHour    Int      @default(100)
  securityLogEvents        Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@map("ai_settings")
}

model SecurityLog {
  id        String           @id @default(uuid())
  userId    String
  eventType String
  details   String           @db.VarChar(500)
  severity  SecuritySeverity @default(low)
  createdAt DateTime         @default(now())

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([severity, createdAt])
  @@map("security_logs")
}

enum SessionStatus {
  INACTIVE
  CONNECTING
  QR_PENDING
  CONNECTED
  DISCONNECTED
  ERROR
}

enum OnboardingStep {
  COLLECT_NAME
  COLLECT_EMAIL
  REQUEST_PHONE
  CHECK_EXISTING_USER
  REQUEST_VERIFICATION_CODE
  VERIFY_CODE
  CHOOSE_ACCOUNT
  CONFIRM_DATA
  CREATING_ACCOUNT
  COMPLETED
}

enum TransactionType {
  EXPENSES
  INCOME
}

enum ConfirmationStatus {
  PENDING
  CONFIRMED
  REJECTED
  EXPIRED
}

enum SynonymSource {
  USER_CONFIRMED
  AI_SUGGESTED
  AUTO_LEARNED
  IMPORTED
  ADMIN_APPROVED
}

enum AIOperationType {
  TRANSACTION_EXTRACTION
  AUDIO_TRANSCRIPTION
  IMAGE_ANALYSIS
  CATEGORY_SUGGESTION
  RAG_EMBEDDING
  INTENT_DETECTION
}

enum AIInputType {
  TEXT
  AUDIO
  IMAGE
}

enum SecuritySeverity {
  low
  medium
  high
}
